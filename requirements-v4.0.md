# ぱるるワールドMobile

## 要件定義書

**Version 4.0**  
2026年2月18日

---

## 改訂履歴

| バージョン | 改訂日 | 改訂者 | 主な変更内容 |
|---|---|---|---|
| 1.0 | 2025年2月 | - | 初版作成 |
| 2.0 | 2026年2月17日 | - | マルチプレイモード追加、選択マス廃止、進む/戻るマスの詳細設定追加、アイテム一覧ページ追加、イベントマス個別設定追加 |
| 3.0 | 2026年2月17日 | - | ミニゲームマス廃止、クイズ機能廃止、コイン概念廃止、関連アイテム(ラッキーコイン)削除、関連イベント(宝箱発見)削除 |
| 3.1 | 2026年2月17日 | - | ゲームタイトルを「ぱるるワールドMobile」に変更 |
| 4.0 | 2026年2月18日 | - | Firebase Realtime Databaseを使用したオンラインマルチプレイ機能を追加 |

---

## 目次

1. [プロジェクト概要](#1-プロジェクト概要)
2. [システム概要](#2-システム概要)
3. [機能要件](#3-機能要件)
   - 3.1 [ステージエディター機能](#31-ステージエディター機能)
   - 3.2 [マス目タイプ仕様](#32-マス目タイプ仕様)
   - 3.3 [アイテム管理ページ](#33-アイテム管理ページ)
   - 3.4 [イベント管理ページ](#34-イベント管理ページ)
   - 3.5 [ゲームプレイ機能](#35-ゲームプレイ機能)
   - 3.6 [マルチプレイモード(ローカル)](#36-マルチプレイモードローカル)
   - 3.7 [オンラインマルチプレイ機能](#37-オンラインマルチプレイ機能)
4. [非機能要件](#4-非機能要件)
5. [データ設計](#5-データ設計)
6. [画面設計](#6-画面設計)
7. [技術スタック](#7-技術スタック)
8. [開発スケジュール](#8-開発スケジュール)
9. [付録: 用語集](#付録-用語集)

---

## 1. プロジェクト概要

### 1.1 プロジェクト名

ぱるるワールドMobile — マス目作成機能・マルチプレイ対応スマートフォン向けゲームアプリケーション

### 1.2 目的

本プロジェクトは、プレイヤーが自由にマス目を作成・配置し、独自のステージを構築できる双六ゲーム「ぱるるワールドMobile」を開発することを目的とする。シンプルさと高いカスタマイズ性を両立し、スマートフォンでの快適なプレイ体験を提供する。

### 1.3 Ver.4.0 主な変更点

- 【追加】Firebase Realtime Databaseを使用したオンラインマルチプレイ機能
- 【追加】ルーム作成・参加機能
- 【追加】リアルタイムゲーム状態同期
- 【追加】Firebase Authentication(匿名認証)

### 1.4 Ver.3.1 主な変更点(参考)

- 【変更】ゲームタイトルを「ぱるるワールドMobile」に正式決定

### 1.5 Ver.3.0 主な変更点(参考)

- 【廃止】ミニゲームマスを削除
- 【廃止】クイズ機能を削除
- 【廃止】コイン概念を全面削除(獲得・表示・リザルト集計すべて)
- 【削除】アイテム「ラッキーコイン」(コイン+20)を削除
- 【削除】イベント「宝箱発見」(コイン+10)を削除

### 1.6 ターゲットユーザー

- カジュアルゲームを楽しむ10代〜40代のスマートフォンユーザー
- 家族や友人グループで一緒に遊びたいユーザー
- 創造的なゲーム体験を求めるユーザー

---

## 2. システム概要

### 2.1 システムの特徴

本システムは、マス目の詳細設定機能とマルチプレイモード(ローカル・オンライン両対応)を備えたカスタマイズ型双六ゲーム「ぱるるワールドMobile」である。コイン・クイズといったミニゲーム要素を排除し、移動・アイテム・イベントに絞ったシンプルで遊びやすいゲームデザインとする。エディターで作成したステージを使い、最大4人が同時にプレイできる。

### 2.2 画面構成

| 画面名 | 概要 |
|---|---|
| ステージエディター画面 | グリッドサイズ設定、マス目の配置・設定を行う |
| アイテム管理画面 | ゲームで使用するアイテムの有効/無効を一覧で設定する |
| イベント管理画面 | イベントの一覧を表示し、各イベントマスへの割り当てを行う |
| プレイヤー設定画面 | プレイ人数・プレイヤー名を設定する |
| プレイ画面(シングル) | 1人でゲームをプレイする |
| プレイ画面(ローカルマルチ) | 2〜4人で順番にゲームをプレイする(同一端末) |
| プレイ画面(オンラインマルチ) | 2〜4人で順番にゲームをプレイする(別端末) |
| ルーム作成・参加画面 | オンラインマルチ用のルーム管理 |
| リザルト画面 | ゲーム終了後の結果を表示する |

---

## 3. 機能要件

### 3.1 ステージエディター機能

#### 3.1.1 グリッド設定

- 3×3から10×10までのグリッドサイズを選択可能
- 行数・列数を個別に数値入力で設定
- グリッドサイズ変更時は自動でボードをリセット

#### 3.1.2 マス目の配置操作

- パレットからマス目タイプを選択してボード上のマスをタップで配置
- スタート(1マス目)とゴール(最終マス)は変更不可
- 配置済みのマスを上書き変更可能
- 進む/戻るマス選択時は移動量の入力ダイアログが表示される
- イベントマス選択時はイベント管理画面に遷移し、割り当てるイベントを選択する

#### 3.1.3 ステージ管理

- ステージの保存機能(ローカルストレージ)
- 保存したステージの読み込み機能
- ステージのリセット機能

---

### 3.2 マス目タイプ仕様

配置可能なマス目は以下の7種類とする。Ver.2.0の「ミニゲームマス」はVer.3.0で廃止。

| マス目タイプ | 盤面表示 | 効果・設定内容 |
|---|---|---|
| スタート | スタート | ゲーム開始位置。変更不可 |
| ゴール | ゴール | ゲーム終了位置。変更不可 |
| 通常 | 通常 | 特に何も起こらない |
| 進む | +N (N=設定値) | エディターで指定したマス数だけ前進。盤面に「+3」のように表示 |
| 戻る | -N (N=設定値) | エディターで指定したマス数だけ後退。盤面に「-2」のように表示 |
| アイテム | アイテム | アイテム管理画面で有効化されたアイテムからランダムで1つ獲得 |
| イベント | イベントタイトル | マスに割り当てられたイベントが発生。盤面にイベントタイトルを表示 |

#### 3.2.1 進む/戻るマスの詳細設定

- 配置時に移動量(1〜10マス)を入力するダイアログを表示
- 盤面上のマスに「+3」「-2」のように移動量を表示
- 配置済みのマスをタップすると移動量を変更可能

---

### 3.3 アイテム管理ページ

#### 3.3.1 概要

ゲームで使用するアイテムの有効/無効を一覧で管理するページ。エディター画面からナビゲーションで遷移できる。有効なアイテムのみがアイテムマスで抽選対象になる。

#### 3.3.2 アイテム一覧

コインに関連するアイテム「ラッキーコイン」はVer.3.0で廃止。残りの4種類を管理する。

| アイテム名 | 効果 | デフォルト |
|---|---|---|
| 魔法の靴 | 次のターン移動量+2 | 有効 |
| 盾 | 戻るマスの効果を1回無効化 | 有効 |
| 双眼鏡 | サイコロを2回振り好きな目を選べる | 有効 |
| タイムストップ | 次の順番のプレイヤーが1ターン休み(マルチ時のみ有効) | 有効 |

#### 3.3.3 操作

- 各アイテムの行にチェックボックスを表示
- チェックON: アイテムマスの抽選対象に含める
- チェックOFF: 抽選対象から除外
- 有効アイテムが0件の場合はアイテムマスで「アイテムなし」を表示
- 設定はローカルストレージに保存される

---

### 3.4 イベント管理ページ

#### 3.4.1 概要

ゲーム内で発生するイベントの一覧を管理するページ。エディターでイベントマスを配置する際に遷移し、そのマスに割り当てるイベントを1つ選択する。

#### 3.4.2 イベント一覧

コインに関連するイベント「宝箱発見」はVer.3.0で廃止。残りの6種類を利用可能とする。

| イベントタイトル | イベント内容 |
|---|---|
| 怪しい商人 | 有効アイテムからランダムで1つ獲得する |
| 突風 | 2マス後退する |
| 幸運の女神 | もう一度サイコロを振れる |
| 落とし穴 | 1回休みになる |
| 追い風 | 3マス前進する |
| 嵐 | 自分以外の全プレイヤーが1マス後退する(マルチ時のみ有効) |

#### 3.4.3 操作

- イベント一覧をリスト表示
- 各イベントをタップするとそのイベントを選択状態にする
- 「決定」ボタンで選択したイベントをマスに割り当て、エディター画面に戻る
- 「キャンセル」ボタンで選択を破棄してエディター画面に戻る
- 割り当てられたイベントマスには盤面上でイベントタイトルを表示する

---

### 3.5 ゲームプレイ機能(共通)

#### 3.5.1 基本操作

- サイコロをタップして1〜6の目を出す
- 出た目の数だけコマが自動で移動
- 移動後にマス目の効果が自動発動
- ゴール到達でそのプレイヤーのゲーム終了

#### 3.5.2 ゲーム状態表示

- 現在位置(マス番号/総マス数)
- 所持アイテム一覧
- 特殊状態の表示(1回休み、もう一度振れる等)

#### 3.5.3 マス目効果の発動

| マス目 | 発動内容 |
|---|---|
| 進む (+N) | 設定されたNマス分だけ自動で前進し、モーダルで通知 |
| 戻る (-N) | 設定されたNマス分だけ自動で後退し、モーダルで通知 |
| アイテム | 有効アイテムからランダムに1つ獲得し、モーダルで通知 |
| イベント | 割り当てられたイベントを実行し、結果をモーダルで表示 |

---

### 3.6 マルチプレイモード(ローカル)

#### 3.6.1 概要

2〜4人のプレイヤーが同じ端末で交互にサイコロを振りプレイするホットシートマルチプレイ方式を採用する。オンラインマルチプレイについては3.7節を参照。

#### 3.6.2 プレイヤー設定

- プレイ開始前に人数(2〜4人)を設定する
- 各プレイヤーの名前を入力する(未入力の場合は「プレイヤーN」と表示)
- 各プレイヤーに異なる色のコマを割り当てる

| プレイヤー番号 | コマカラー |
|---|---|
| プレイヤー1 | 青 |
| プレイヤー2 | 赤 |
| プレイヤー3 | 緑 |
| プレイヤー4 | 黄 |

#### 3.6.3 ターン管理

- プレイヤー1から順番にターンが回る
- 現在のターンのプレイヤー名を画面上部に明示する
- サイコロを振ってコマを移動後、次のプレイヤーへターンが移る
- 1回休みの場合は対象プレイヤーのターンをスキップ
- ゴールに到達したプレイヤーは順位が確定し、以降のターンをスキップ
- 全プレイヤーがゴールするか1位が決まった時点でゲーム終了

#### 3.6.4 マルチプレイ専用効果

- 「タイムストップ」アイテム使用: 次の順番のプレイヤーが1回休み
- 「嵐」イベント: 自分以外の全プレイヤーが1マス後退

#### 3.6.5 ゲーム終了・リザルト画面

- 全プレイヤーのゴール順位を一覧表示
- 各プレイヤーの所持アイテム数を表示(コイン表示は廃止)
- 「もう一度」ボタンで同じステージを再プレイ
- 「エディターに戻る」ボタンでエディター画面に戻る

---

### 3.7 オンラインマルチプレイ機能

#### 3.7.1 概要

Firebase Realtime Databaseを使用し、異なる端末間でリアルタイムにゲーム状態を同期するオンラインマルチプレイ機能を提供する。プライベート用途(〜10人)を想定し、Firebase無料枠内で運用可能な設計とする。

#### 3.7.2 技術構成

| コンポーネント | 技術 | 用途 |
|---|---|---|
| リアルタイムDB | Firebase Realtime Database | ゲーム状態の同期・保存 |
| 認証 | Firebase Authentication | プレイヤー認証(匿名認証) |
| ホスティング | Firebase Hosting | 静的ファイル配信(オプション) |

#### 3.7.3 ゲームルーム管理

- **ルーム作成**: ホストプレイヤーがルームIDを発行
- **ルーム参加**: 他のプレイヤーがルームIDを入力して参加
- **ルームID形式**: 9桁のランダム英数字(例: a3k9m2x7p)
- **ルーム定員**: 2〜4人
- **ルーム有効期限**: 最終アクティビティから24時間(自動削除)

#### 3.7.4 データ構造

Firebase Realtime Databaseに以下の構造でデータを保存:

```
/rooms/{roomId}/
  hostId: "player1"
  stageData: {...} // ステージ情報
  players/
    {playerId}/
      name: "プレイヤー名"
      position: 0
      items: [...]
      skipTurn: false
  gameState/
    currentTurn: 0
    currentPlayerId: "player1"
    phase: "waiting" | "playing" | "finished"
  createdAt: timestamp
```

#### 3.7.5 リアルタイム同期処理

- **サイコロの結果**: ホストが振った結果を全員に即座に配信
- **プレイヤー位置**: 位置情報の変更を全クライアントに同期
- **イベント発生**: イベント内容を全プレイヤーに通知
- **ターン切り替え**: 次のプレイヤーへのターン移行を自動同期
- **リスナー登録**: 各クライアントはRealtime Databaseの変更を監視

#### 3.7.6 接続管理

- **接続状態監視**: Firebase .info/connected を使用
- **切断検知**: プレイヤーが切断した場合は他のプレイヤーに通知
- **再接続**: 切断後の自動再接続をサポート
- **ホスト離脱対策**: ホストが離脱した場合は次のプレイヤーがホストに昇格

#### 3.7.7 セキュリティルール

Firebase Security Rulesで以下のアクセス制御を実装:

```json
{
  "rules": {
    "rooms": {
      "$roomId": {
        ".read": "auth != null && 
                  data.child('players').hasChild(auth.uid)",
        ".write": "auth != null && 
                   (!data.exists() || 
                    data.child('players').hasChild(auth.uid))"
      }
    }
  }
}
```

#### 3.7.8 画面フロー

1. **ホスト**: 「オンラインルーム作成」→ ルームID表示 → プレイヤー参加待機 → ゲーム開始
2. **参加者**: 「オンラインルーム参加」→ ルームID入力 → 参加完了 → ゲーム開始
3. **ゲーム中**: ローカルマルチと同じUI(リアルタイム同期のみ追加)
4. **終了時**: リザルト表示 → 「もう一度」または「退出」

#### 3.7.9 無料枠での運用可能性

| 項目 | Firebase無料枠 | 10人利用時の使用量 | 判定 |
|---|---|---|---|
| 同時接続数 | 100接続 | 最大10接続 | ✓ 余裕あり |
| データ保存容量 | 1GB | 約10MB | ✓ 余裕あり |
| データ転送量 | 10GB/月 | 約100MB/月 | ✓ 余裕あり |
| 認証ユーザー数 | 無制限 | 10人 | ✓ 余裕あり |

※プライベート用途(〜10人)であれば、完全無料で運用可能

#### 3.7.10 ローカルマルチとの共存

- プレイモード選択画面で「ローカル」「オンライン」を切り替え
- コードベースは共通化し、通信部分のみ分岐
- オンライン機能はオプションとして実装(未使用時は影響なし)

---

## 4. 非機能要件

### 4.1 パフォーマンス要件

- 初回ロード時間: 3秒以内
- 画面遷移(モード切替): 0.5秒以内
- サイコロアニメーション: 0.5秒
- マス移動アニメーション: 0.6秒
- オンラインマルチでの同期遅延: 1秒以内

### 4.2 ユーザビリティ要件

- スマートフォン画面に最適化されたUI(最大幅800px)
- タッチ操作に対応した直感的なインターフェース
- マルチプレイ時は現在のプレイヤーが一目でわかる表示
- 日本語による分かりやすい説明文
- 進む/戻るマスの移動量が盤面で直感的に読み取れるデザイン
- オンライン接続状態の明示(接続中・切断中の表示)

### 4.3 互換性要件

- iOS Safari(iOS 14以降)
- Android Chrome(Android 10以降)
- PCブラウザ(Chrome / Firefox / Safari / Edge 最新版)

### 4.4 セキュリティ要件

- ローカルストレージへの安全なデータ保存
- 個人情報を収集しない設計
- Firebase Security Rulesによるデータアクセス制御
- ルームIDの推測困難性(9桁ランダム英数字)

---

## 5. データ設計

### 5.1 ローカルストレージ構造

| キー名 | 保存内容 | 更新タイミング |
|---|---|---|
| sugorokuStage | ステージデータ(グリッドサイズ・全マス情報) | 保存ボタン押下時 |
| sugorokuItems | アイテムの有効/無効フラグ一覧 | アイテム管理画面での変更時 |

### 5.2 ステージデータ構造(マス目オブジェクト)

各マス目は以下のフィールドを持つオブジェクトで管理する。minigame タイプはVer.3.0で廃止。

| フィールド名 | 型 | 説明 |
|---|---|---|
| id | string | マス目タイプID: normal / forward / backward / item / event / start / goal |
| name | string | 盤面表示名 |
| color | string | 盤面表示色のCSSクラス名 |
| effect.type | string | 効果タイプ: move / item / event / null |
| effect.value | number | 移動量(進む/戻るマスのみ。正数=前進、負数=後退) |
| effect.eventId | string | 割り当てイベントID(イベントマスのみ) |
| effect.eventTitle | string | 盤面表示用イベントタイトル(イベントマスのみ) |

### 5.3 ゲーム状態管理(JavaScript変数)

| 変数名 | 型 | 内容 |
|---|---|---|
| mode | string | 現在のモード: editor / play-single / play-local / play-online / items / events |
| players | array | プレイヤー情報の配列(名前・位置・アイテム・スキップフラグ) |
| currentPlayerIndex | number | 現在のターンのプレイヤーインデックス |
| board | array | マス目情報の配列 |
| enabledItems | object | アイテム名をキーとした有効/無効フラグのマップ |
| roomId | string | オンラインマルチのルームID(オンライン時のみ) |
| firebaseRef | object | Firebase Databaseへの参照(オンライン時のみ) |

### 5.4 Firebase Realtime Database構造

```
/rooms/
  {roomId}/
    hostId: string
    createdAt: timestamp
    stageData:
      gridSize: { rows: number, cols: number }
      board: array
    players/
      {playerId}/
        name: string
        position: number
        items: array
        skipTurn: boolean
        connected: boolean
    gameState/
      currentTurn: number
      currentPlayerId: string
      phase: "waiting" | "playing" | "finished"
      lastDiceRoll: number
```

---

## 6. 画面設計

### 6.1 画面遷移

- エディター画面 ⇔ アイテム管理画面
- エディター画面 ⇔ イベント管理画面(イベントマス配置時に自動遷移)
- エディター画面 → プレイモード選択画面 → プレイヤー設定画面 → プレイ画面
- エディター画面 → プレイモード選択画面 → ルーム作成/参加画面 → プレイ画面(オンライン)
- プレイ画面 → リザルト画面 → エディター画面

### 6.2 エディター画面

- ヘッダー(タイトル・アイテム管理ボタン)
- グリッドサイズ設定エリア
- マス目タイプパレット(5種類: 通常・進む・戻る・アイテム・イベント)
- ゲームボード(グリッド表示)
- 操作ボタン(保存・読込・リセット・プレイ開始)

### 6.3 アイテム管理画面

- ページタイトル「アイテム管理」
- アイテム一覧(名前・効果・チェックボックス) ※4アイテム
- 「戻る」ボタン

### 6.4 イベント管理画面

- ページタイトル「イベントを選択」
- イベント一覧(タイトル・内容・選択ラジオボタン) ※6イベント
- 「決定」「キャンセル」ボタン

### 6.5 プレイモード選択画面

- 「ローカルマルチ」ボタン
- 「オンラインマルチ」ボタン
- 「シングルプレイ」ボタン
- 「戻る」ボタン

### 6.6 プレイヤー設定画面(ローカルマルチ)

- 人数選択(2〜4人)
- 各プレイヤーの名前入力フィールド
- 「ゲーム開始」ボタン

### 6.7 ルーム作成/参加画面(オンラインマルチ)

**ルーム作成タブ:**
- 「ルームを作成」ボタン
- 作成されたルームIDの表示エリア
- 参加プレイヤー一覧(リアルタイム更新)
- 「ゲーム開始」ボタン

**ルーム参加タブ:**
- ルームID入力フィールド
- 「参加」ボタン
- プレイヤー名入力フィールド

### 6.8 プレイ画面

- 現在のプレイヤー名表示バナー(マルチ時)
- 接続状態インジケーター(オンライン時)
- ゲーム状態表示エリア(位置・所持アイテム)
- サイコロ表示エリア
- ゲームボード(各プレイヤーのコマ表示)

### 6.9 リザルト画面

- 順位一覧表(プレイヤー名・順位・アイテム数)
- 「もう一度プレイ」「エディターへ」ボタン

---

## 7. 技術スタック

### 7.1 フロントエンド

| 技術 | バージョン | 用途 |
|---|---|---|
| HTML5 | - | マークアップ |
| CSS3 | - | スタイリング・アニメーション |
| JavaScript (ES6+) | - | ゲームロジック・DOM操作 |

### 7.2 バックエンド・オンライン機能

| 技術 | バージョン | 用途 |
|---|---|---|
| Firebase Realtime Database | 最新版 | オンラインマルチプレイのゲーム状態同期 |
| Firebase Authentication | 最新版 | 匿名認証によるプレイヤー識別 |
| Firebase SDK (CDN) | 9.x | ブラウザからFirebaseへのアクセス |

### 7.3 データストレージ

- LocalStorage API(ステージデータ・アイテム設定の永続化)
- Firebase Realtime Database(オンラインマルチプレイのゲーム状態)

### 7.4 実行環境

- iOS Safari(iOS 14以降)
- Android Chrome(Android 10以降)
- PCブラウザ(Chrome / Firefox / Safari / Edge 最新版)

---

## 8. 開発スケジュール

### 8.1 開発フェーズ

| フェーズ | 期間目安 | 主な成果物 |
|---|---|---|
| Phase 1: 基盤整備 | 1週間 | エディター画面・マス配置基本機能 |
| Phase 2: マス効果実装 | 1週間 | 進む/戻る設定UI・アイテム管理画面・イベント管理画面 |
| Phase 3: シングルプレイ | 1週間 | プレイ画面・各マス効果・モーダル |
| Phase 4: ローカルマルチ | 1週間 | プレイヤー設定・ターン管理・リザルト画面 |
| Phase 5: オンラインマルチ | 1.5週間 | Firebase連携・ルーム管理・リアルタイム同期 |
| Phase 6: テスト・調整 | 1週間 | 動作確認・UIブラッシュアップ・バグ修正 |

**合計開発期間**: 約6.5週間

### 8.2 マイルストーン

- **M1**: エディター＋全マスタイプの配置が可能
- **M2**: アイテム管理・イベント管理ページ完成
- **M3**: シングルプレイで最初から最後まで遊べる
- **M4**: ローカルマルチプレイモード完成
- **M5**: オンラインマルチプレイモード完成
- **M6**: テスト完了・リリース

---

## 付録: 用語集

| 用語 | 説明 |
|---|---|
| 双六 | サイコロを振って出た目の数だけコマを進めるボードゲーム |
| マス目 | ゲームボード上の1つのセル。タイプにより異なる効果を持つ |
| ステージ | ゲームボード全体。エディターで作成・保存できる |
| グリッド | マス目を配置するための格子状レイアウト |
| ホットシートマルチプレイ | 1台の端末を複数人が交互に操作するマルチプレイ方式 |
| オンラインマルチプレイ | 各プレイヤーが自分の端末からリアルタイムで同期してプレイする方式 |
| コマ | 各プレイヤーの現在位置を示すゲームピース |
| ターン | 1人のプレイヤーがサイコロを振って行動する1回分の単位 |
| LocalStorage | Webブラウザにデータを保存するためのAPI |
| Firebase Realtime Database | Googleが提供するリアルタイムNoSQLデータベース |
| ルームID | オンラインマルチプレイでゲームルームを識別するための一意のID |

---

**以上**
