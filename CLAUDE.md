# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

---

\## ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¨­è¨ˆ



\### 1. Planãƒ¢ãƒ¼ãƒ‰ã‚’åŸºæœ¬ã¨ã™ã‚‹

\- 3ã‚¹ãƒ†ãƒƒãƒ—ä»¥ä¸Š or ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«é–¢ã‚ã‚‹ã‚¿ã‚¹ã‚¯ã¯å¿…ãšPlanãƒ¢ãƒ¼ãƒ‰ã§é–‹å§‹ã™ã‚‹

\- é€”ä¸­ã§ã†ã¾ãã„ã‹ãªããªã£ãŸã‚‰ã€ç„¡ç†ã«é€²ã‚ãšã™ãã«ç«‹ã¡æ­¢ã¾ã£ã¦å†è¨ˆç”»ã™ã‚‹

\- æ§‹ç¯‰ã ã‘ã§ãªãã€æ¤œè¨¼ã‚¹ãƒ†ãƒƒãƒ—ã«ã‚‚Planãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ã†

\- æ›–æ˜§ã•ã‚’æ¸›ã‚‰ã™ãŸã‚ã€å®Ÿè£…å‰ã«è©³ç´°ãªä»•æ§˜ã‚’æ›¸ã



\### 2. ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæˆ¦ç•¥

\- ãƒ¡ã‚¤ãƒ³ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã«ä¿ã¤ãŸã‚ã«ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ç©æ¥µçš„ã«æ´»ç”¨ã™ã‚‹

\- ãƒªã‚µãƒ¼ãƒãƒ»èª¿æŸ»ãƒ»ä¸¦åˆ—åˆ†æã¯ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ä»»ã›ã‚‹

\- è¤‡é›‘ãªå•é¡Œã«ã¯ã€ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½¿ã£ã¦ã‚ˆã‚Šå¤šãã®è¨ˆç®—ãƒªã‚½ãƒ¼ã‚¹ã‚’æŠ•å…¥ã™ã‚‹

\- é›†ä¸­ã—ã¦å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ã€ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ1ã¤ã«ã¤ã1ã‚¿ã‚¹ã‚¯ã‚’å‰²ã‚Šå½“ã¦ã‚‹



\### 3. è‡ªå·±æ”¹å–„ãƒ«ãƒ¼ãƒ—

\- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ä¿®æ­£ã‚’å—ã‘ãŸã‚‰å¿…ãš `tasks/lessons.md` ã«ãã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¨˜éŒ²ã™ã‚‹

\- åŒã˜ãƒŸã‚¹ã‚’ç¹°ã‚Šè¿”ã•ãªã„ã‚ˆã†ã«ã€è‡ªåˆ†ã¸ã®ãƒ«ãƒ¼ãƒ«ã‚’æ›¸ã

\- ãƒŸã‚¹ç‡ãŒä¸‹ãŒã‚‹ã¾ã§ã€ãƒ«ãƒ¼ãƒ«ã‚’å¾¹åº•çš„ã«æ”¹å–„ã—ç¶šã‘ã‚‹

\- ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ™‚ã«ã€ãã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«é–¢é€£ã™ã‚‹lessonsã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹



\### 4. å®Œäº†å‰ã«å¿…ãšæ¤œè¨¼ã™ã‚‹

\- å‹•ä½œã‚’è¨¼æ˜ã§ãã‚‹ã¾ã§ã€ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã¨ãƒãƒ¼ã‚¯ã—ãªã„

\- å¿…è¦ã«å¿œã˜ã¦mainãƒ–ãƒ©ãƒ³ãƒã¨è‡ªåˆ†ã®å¤‰æ›´ã®å·®åˆ†ã‚’ç¢ºèªã™ã‚‹

\- ã€Œã‚¹ã‚¿ãƒƒãƒ•ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¯ã“ã‚Œã‚’æ‰¿èªã™ã‚‹ã‹ï¼Ÿã€ã¨è‡ªå•ã™ã‚‹

\- ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã€ãƒ­ã‚°ã‚’ç¢ºèªã—ã€æ­£ã—ãå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¤ºã™



\### 5. ã‚¨ãƒ¬ã‚¬ãƒ³ãƒˆã•ã‚’è¿½æ±‚ã™ã‚‹ï¼ˆãƒãƒ©ãƒ³ã‚¹ã‚ˆãï¼‰

\- é‡è¦ãªå¤‰æ›´ã‚’ã™ã‚‹å‰ã«ã€Œã‚‚ã£ã¨ã‚¨ãƒ¬ã‚¬ãƒ³ãƒˆãªæ–¹æ³•ã¯ãªã„ã‹ï¼Ÿã€ã¨ä¸€åº¦ç«‹ã¡æ­¢ã¾ã‚‹

\- ãƒãƒƒã‚¯çš„ãªä¿®æ­£ã«æ„Ÿã˜ãŸã‚‰ã€Œä»ŠçŸ¥ã£ã¦ã„ã‚‹ã“ã¨ã‚’ã™ã¹ã¦è¸ã¾ãˆã¦ã€ã‚¨ãƒ¬ã‚¬ãƒ³ãƒˆãªè§£æ±ºç­–ã‚’å®Ÿè£…ã™ã‚‹ã€

\- ã‚·ãƒ³ãƒ—ãƒ«ã§æ˜ç™½ãªä¿®æ­£ã«ã¯ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ï¼ˆéå‰°è¨­è¨ˆã—ãªã„ï¼‰

\- æç¤ºã™ã‚‹å‰ã«è‡ªåˆ†ã®ä½œæ¥­ã«è‡ªå•è‡ªç­”ã™ã‚‹



\### 6. è‡ªå¾‹çš„ãªãƒã‚°ä¿®æ­£

\- ãƒã‚°ãƒ¬ãƒãƒ¼ãƒˆã‚’å—ã‘ãŸã‚‰ã€æ‰‹å–ã‚Šè¶³å–ã‚Šæ•™ãˆã¦ã‚‚ã‚‰ã‚ãšã«ãã®ã¾ã¾ä¿®æ­£ã™ã‚‹

\- ãƒ­ã‚°ãƒ»ã‚¨ãƒ©ãƒ¼ãƒ»å¤±æ•—ã—ã¦ã„ã‚‹ãƒ†ã‚¹ãƒˆã‚’è¦‹ã¦ã€è‡ªåˆ†ã§è§£æ±ºã™ã‚‹

\- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåˆ‡ã‚Šæ›¿ãˆã‚’ã‚¼ãƒ­ã«ã™ã‚‹

\- è¨€ã‚ã‚Œãªãã¦ã‚‚ã€å¤±æ•—ã—ã¦ã„ã‚‹CIãƒ†ã‚¹ãƒˆã‚’ä¿®æ­£ã—ã«è¡Œã



---



\## ã‚¿ã‚¹ã‚¯ç®¡ç†



1\. \*\*ã¾ãšè¨ˆç”»ã‚’ç«‹ã¦ã‚‹\*\*ï¼šãƒã‚§ãƒƒã‚¯å¯èƒ½ãªé …ç›®ã¨ã—ã¦ `tasks/todo.md` ã«è¨ˆç”»ã‚’æ›¸ã

2\. \*\*è¨ˆç”»ã‚’ç¢ºèªã™ã‚‹\*\*ï¼šå®Ÿè£…ã‚’é–‹å§‹ã™ã‚‹å‰ã«ç¢ºèªã™ã‚‹

3\. \*\*é€²æ—ã‚’è¨˜éŒ²ã™ã‚‹\*\*ï¼šå®Œäº†ã—ãŸé …ç›®ã‚’éšæ™‚ãƒãƒ¼ã‚¯ã—ã¦ã„ã

4\. \*\*å¤‰æ›´ã‚’èª¬æ˜ã™ã‚‹\*\*ï¼šå„ã‚¹ãƒ†ãƒƒãƒ—ã§é«˜ãƒ¬ãƒ™ãƒ«ã®ã‚µãƒãƒªãƒ¼ã‚’æä¾›ã™ã‚‹

5\. \*\*çµæœã‚’ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–ã™ã‚‹\*\*ï¼š`tasks/todo.md` ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹

6\. \*\*å­¦ã³ã‚’è¨˜éŒ²ã™ã‚‹\*\*ï¼šä¿®æ­£ã‚’å—ã‘ãŸå¾Œã« `tasks/lessons.md` ã‚’æ›´æ–°ã™ã‚‹



---



\## ã‚³ã‚¢åŸå‰‡



\- \*\*ã‚·ãƒ³ãƒ—ãƒ«ç¬¬ä¸€\*\*ï¼šã™ã¹ã¦ã®å¤‰æ›´ã‚’ã§ãã‚‹é™ã‚Šã‚·ãƒ³ãƒ—ãƒ«ã«ã™ã‚‹ã€‚å½±éŸ¿ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æœ€å°é™ã«ã™ã‚‹ã€‚

\- \*\*æ‰‹ã‚’æŠœã‹ãªã„\*\*ï¼šæ ¹æœ¬åŸå› ã‚’è¦‹ã¤ã‘ã‚‹ã€‚ä¸€æ™‚çš„ãªä¿®æ­£ã¯é¿ã‘ã‚‹ã€‚ã‚·ãƒ‹ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®æ°´æº–ã‚’ä¿ã¤ã€‚

\- \*\*å½±éŸ¿ã‚’æœ€å°åŒ–ã™ã‚‹\*\*ï¼šå¤‰æ›´ã¯å¿…è¦ãªç®‡æ‰€ã®ã¿ã«ã¨ã©ã‚ã‚‹ã€‚ãƒã‚°ã‚’æ–°ãŸã«å¼•ãè¾¼ã¾ãªã„ã€‚





## åŸºæœ¬æ–¹é‡
playwritghtã‚’ä½¿ç”¨ã—ãŸãƒ‡ãƒãƒƒã‚¯æ™‚ã«ä½œæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€C:\Users\mirai\Documents\my_app\palulu-world-mobile\.playwright-mcpã«ãƒ‡ãƒãƒƒã‚¯ã—ãŸæ—¥æ™‚ã‚’è¨˜è¼‰ã—ãŸãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œã‚Šã€æ ¼ç´ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

## Project Overview

**ã±ã‚‹ã‚‹ãƒ¯ãƒ¼ãƒ«ãƒ‰Mobile** is a Japanese mobile-first browser-based board game (åŒå…­). Modes:

- **Board Editor** â€” design custom boards with a tile palette
- **Single-player** â€” solo play
- **Local Multiplayer** â€” 2â€“12 players on the same device
- **Online Multiplayer** â€” Firebase-backed room system (partially implemented)

No build tooling. Open `index.html` directly in any browser.

---

## Architecture

**No build tooling** â€” open `index.html` directly in any browser. No npm, no build step, no tests.

**GitHub Pages:** https://mokablack.github.io/palulu-world-mobile/

### File Structure

```
index.html        (~216 lines) â€” HTML skeleton only
css/
  styles.css      (~761 lines) â€” all styles
js/
  game.js         (~3827 lines) â€” all game logic
tasks/
  todo.md         â€” ã‚¿ã‚¹ã‚¯ä¸€è¦§ï¼ˆä½œæ¥­ã”ã¨ã«ä½œæˆï¼‰
  lessons.md      â€” ä¿®æ­£ãƒ‘ã‚¿ãƒ¼ãƒ³ã®è¨˜éŒ²ï¼ˆè‡ªå·±æ”¹å–„ãƒ«ãƒ¼ãƒ—ç”¨ï¼‰
```

`index.html` loads Font Awesome 6.7.2 CDN, `css/styles.css`, Firebase SDK v11 Compat CDN (3 scripts: `firebase-app-compat`, `firebase-auth-compat`, `firebase-database-compat`), then `js/game.js`.

### `js/game.js` Section Order (delimited by `// ========== ... ==========`)

1. ãƒ‡ãƒ¼ã‚¿å®šç¾© â€” `TILE_TYPES`, `ITEMS`, `EVENTS`, `escapeHtml()`, `itemLabel()`
2. ã‚²ãƒ¼ãƒ çŠ¶æ…‹ â€” `gameState`
3. åˆæœŸåŒ– â€” `init()`
4. Firebaseè¨­å®š
5. ãƒœãƒ¼ãƒ‰ç®¡ç† â€” `initializeBoard()`, `renderBoard()`
6. ãƒ‘ãƒ¬ãƒƒãƒˆ â€” tile palette UI
7. ã‚¢ã‚¤ãƒ†ãƒ ç®¡ç†
8. ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†
9. ã‚¹ãƒ†ãƒ¼ã‚¸ä¿å­˜/èª­ã¿è¾¼ã¿ â€” localStorage
10. ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ â€” `switchMode()` + `ALL_MODES` table
11. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®š
12. ã‚²ãƒ¼ãƒ é–‹å§‹ â€” `startSinglePlay()`, `startLocalMulti()`
13. ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒãƒ«ãƒ (Firebaseå®Ÿè£…)
14. ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ â€” dice, movement, tile effects
15. ã‚¢ã‚¤ãƒ†ãƒ å–å¾—å…±é€šå‡¦ç†
16. é€†ã•ã¾ã‚¹ãƒ—ãƒ¬ãƒ¼ / ã‚³ã‚·ãƒ³ãƒ‰ã‚¹ãƒ—ãƒ¬ãƒ¼ / ãƒãƒ™ãƒ« / å‘ªã‚ã‚ŒãŸäººå½¢ / ã‚¹ãƒŠãƒƒãƒãƒ£ãƒ¼ / ãƒˆãƒ³ã‚«ãƒ / å½¢ä»£ï¼‹ä¸‹å‰‹ä¸Šãƒãƒ³ãƒ‰ãƒ© / é‡˜ï¼‹ãƒˆãƒ³ã‚«ãƒã‚³ãƒ³ãƒœ / é‡˜ã®è¨­ç½® / è«¸åˆƒã®å‰£ (`morohajokenTarget()`) (per-item handlers)
17. æ€ªã—ã„å•†äººUI â€” `showMerchantDialog()` and related
18. ãƒ¢ãƒ¼ãƒ€ãƒ« â€” `showModal()`, `buildResultText()`, `nextTurn()`
19. è‡ªåˆ†ã‚’ã‚¢ãƒ”ãƒ¼ãƒ«ã—ã¦ï¼ / å¥½ããªã ã‘é€²ã‚“ã§ã„ã„ã‚ˆ / ä»Šæ—¥ã®ãƒ©ãƒƒã‚­ãƒ¼ãƒŠãƒ³ãƒãƒ¼ã¯ï¼Ÿ / æ€’ã‚‰ã›ãŸã‚‰10é€²ã‚€ (custom event UIs)
20. ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒãƒ£ãƒ¼ â€” `closeModal*` bridge functions, `ACTION_HANDLERS`, `document.addEventListener('click', ...)`, `init()` call

---

## Data Model

### `gameState`

```javascript
let gameState = {
    // Editor
    mode: 'editor',                     // 'editor' | 'single' | 'local' | 'online'
    gridSize: { rows: 5, cols: 5 },
    board: [],
    selectedTileType: TILE_TYPES.NORMAL,
    enabledItems: {},                   // { [itemId]: boolean }
    selectedEventForTile: null,
    editingTileIndex: null,

    // Gameplay
    playMode: null,                     // 'single' | 'local' | 'online'
    players: [],
    currentPlayerIndex: 0,
    diceValue: 1,
    isRolling: false,
    winShown: false,
    nailTraps: {},                      // { [tileIndex]: placingPlayerIndex }

    // Item effect flags (active for current turn)
    bootsActive: false,
    binocularsActive: false,
    koshindoActive: false,
    sakasamaActive: false,

    // Firebase
    firebaseConfig: null,
    firebaseInitialized: false,
    roomId: null,
    playerId: null,
    isHost: false,
    firebaseRefs: {}
};
```

### Tile object

```javascript
{
    id: 'normal' | 'forward' | 'backward' | 'item' | 'event' | 'rest' | 'start' | 'goal',
    name: string,
    color: string,          // CSS class e.g. 'tile-normal'
    effect: null | {
        type: 'move' | 'item' | 'event' | 'rest',
        value?: number,
        eventId?: string,
        eventTitle?: string,
        eventText?: string,
        eventEffect?: number | 'merchant' | 'extraTurn' | 'skip' | 'storm'
                    | 'blackhole' | 'whitehole' | 'mask' | 'average'
                    | 'forceend' | 'nameback' | 'ganbare' | 'resetall' | 'newstart'
                    | 'angry' | 'self_appeal' | 'freemove' | 'luckynumber'
    }
}
```

### Player object

```javascript
{
    name: string,
    position: number,       // Index into gameState.board
    items: string[],        // Collected item IDs
    skipTurns: number,      // Turns remaining to skip (0 = no skip)
    immuneTurns: number,    // Turns remaining with negative-effect immunity (max 3)
    babelTarget: number | null  // Player index for ãƒãƒ™ãƒ« item effect
}
```

### Constants

```javascript
const TILE_TYPES = { NORMAL, FORWARD, BACKWARD, ITEM, EVENT, REST, START, GOAL };
// REST: { id: 'rest', name: 'ä¼‘ã¿', color: 'tile-rest', effect: { type: 'rest', value: 1 } }

// Items (16 total) â€” each has id, name, icon (emoji), effect (string)
const ITEMS = [
    { id: 'boots',       name: 'é­”æ³•ã®é´',         icon: 'ğŸ‘Ÿ', ... },
    { id: 'shield',      name: 'ç›¾',               icon: 'ğŸ›¡ï¸', ... },  // reactive: prompted on backward tile
    { id: 'binoculars',  name: 'åŒçœ¼é¡',           icon: 'ğŸ”­', ... },
    { id: 'timestop',    name: 'ã‚¿ã‚¤ãƒ ã‚¹ãƒˆãƒƒãƒ—',   icon: 'â¸ï¸', ... },
    { id: 'koshindo',    name: 'ã‚³ã‚·ãƒ³ãƒ‰ã‚¹ãƒ—ãƒ¬ãƒ¼', icon: 'ğŸ’¨', ... },
    { id: 'sakasama',    name: 'é€†ã•ã¾ã‚¹ãƒ—ãƒ¬ãƒ¼',   icon: 'ğŸ”„', ... },
    { id: 'star',        name: 'ã‚¹ã‚¿ãƒ¼',           icon: 'â­', ... },
    { id: 'curseddoll',  name: 'å‘ªã‚ã‚ŒãŸäººå½¢',     icon: 'ğŸ§¸', ... },
    { id: 'babel',       name: 'ãƒãƒ™ãƒ«',           icon: 'ğŸŒ€', ... },  // displayed as star externally
    { id: 'snatcher',    name: 'ã‚¹ãƒŠãƒƒãƒãƒ£ãƒ¼',     icon: 'ğŸ£', ... },  // ä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’1ã¤å¥ªã†
    { id: 'nail',        name: 'é‡˜',               icon: 'ğŸ“Œ', ... },
    { id: 'hammer',      name: 'ãƒˆãƒ³ã‚«ãƒ',         icon: 'ğŸ”¨', ... },
    { id: 'katashiro',   name: 'å½¢ä»£',             icon: 'ğŸª†', ... },  // å—å‹•ã‚¢ã‚¤ãƒ†ãƒ : æ”»æ’ƒåŠ¹æœã‚’ç¬¬ä¸‰è€…ã«è»¢å«
    { id: 'gekokujo',    name: 'ä¸‹å‰‹ä¸Š',           icon: 'âš”ï¸', ... },  // ãƒˆãƒƒãƒ—ã¨ä½ç½®äº¤æ›ï¼ˆå…¨ã‚¢ã‚¤ãƒ†ãƒ å¤±ã†ï¼‰
    { id: 'kagemaiha',   name: 'å½±èˆè‘‰',           icon: 'ğŸƒ', ... },
    { id: 'morohajoken', name: 'è«¸åˆƒã®å‰£',         icon: 'ğŸ—¡ï¸', ... },  // 100é¢ãƒ€ã‚¤ã‚¹: 1â†’ã‚´ãƒ¼ãƒ«1ãƒã‚¹å‰, ä»–â†’ã‚¹ã‚¿ãƒ¼ãƒˆã¸; åŒãƒã‚¹ã®ä»–PLã«ã‚‚ä½¿ç”¨å¯
];

// Events (19 total)
const EVENTS = [
    { id: 'merchant',    effect: 'merchant'    },  // 3æŠã‚¢ã‚¤ãƒ†ãƒ é¸æŠUI
    { id: 'wind',        effect: -2            },
    { id: 'goddess',     effect: 'extraTurn'   },
    { id: 'pit',         effect: 'skip'        },
    { id: 'tailwind',    effect: 3             },
    { id: 'storm',       effect: 'storm'       },
    { id: 'blackhole',   effect: 'blackhole'   },
    { id: 'whitehole',   effect: 'whitehole'   },
    { id: 'mask',        effect: 'mask'        },  // åˆ¥ã®è¦†é¢ãƒã‚¹ã¸ãƒ¯ãƒ¼ãƒ—
    { id: 'average',     effect: 'average'     },  // å…¨å“¡åŒã˜ãƒã‚¹ã¸
    { id: 'forceend',    effect: 'forceend'    },  // å¼·åˆ¶ã‚²ãƒ¼ãƒ çµ‚äº†
    { id: 'nameback',    effect: 'nameback'    },  // åå‰æ–‡å­—æ•°åˆ†æˆ»ã‚‹
    { id: 'ganbare',     effect: 'ganbare'     },  // è¦‹å‡ºã—ã®ã¿è¡¨ç¤ºï¼ˆæœ¬æ–‡ãªã—ï¼‰
    { id: 'resetall',    effect: 'resetall'    },  // å…¨å“¡ã‚¹ã‚¿ãƒ¼ãƒˆã¸
    { id: 'newstart',    effect: 'newstart'    },  // ç›¤é¢å†æ§‹æˆ
    { id: 'angry',       effect: 'angry'       },  // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆâ†’é¸ã°ã‚ŒãŸPãŒé€²ã‚€/æˆ»ã‚‹
    { id: 'self_appeal', effect: 'self_appeal' },  // 30ç§’ã‚¢ãƒ”ãƒ¼ãƒ«â†’ä»–PLæŠ•ç¥¨ã§é€²ã‚€
    { id: 'freemove',    effect: 'freemove'    },  // ä»»æ„ã®ãƒã‚¹æ•°å…¥åŠ›ã—ã¦å‰é€²
    { id: 'luckynumber', effect: 'luckynumber' },  // æ•°å€¤å…¥åŠ›â†’ãƒ©ãƒ³ãƒ€ãƒ åŠ¹æœ
];
```

---

## Key Functions

| Function | Purpose |
|---|---|
| `init()` | Entry point on page load |
| `escapeHtml(str)` | XSS-safe HTML escaping â€” use for all user input embedded in `innerHTML` |
| `itemLabel(itemId)` | Returns `"icon name"` string for display; resolves `babel`â†’`star` |
| `switchMode(mode)` | Navigate between editor / items / events / play screens via `ALL_MODES` table |
| `initializeBoard()` | Reset board to default |
| `renderBoard()` | Re-render board grid from `gameState.board`; shows FA icons for item/blackhole/whitehole tiles |
| `generateRandomStage()` | Generate a random board (~30% normal / ~30% item / ~40% event) |
| `saveStage()` / `loadStage()` | Persist/restore board to localStorage |
| `startSinglePlay()` / `startLocalMulti()` | Transition to active gameplay |
| `rollDice()` | Animate dice and compute movement |
| `movePlayer(steps)` | Advance current player with step-by-step animation |
| `executeTileEffect(tile)` | Evaluate effect on landing; checks immunity + curseddoll first |
| `handleEvent(eventEffect)` | Dispatch event effects including all new event types |
| `showMerchantDialog()` | 3æŠã‚¢ã‚¤ãƒ†ãƒ é¸æŠUI for æ€ªã—ã„å•†äºº event; each offer has 25% chance of being fake (æ¶ˆæ»…) |
| `useKagemaiha()` | Move to 1-rank-above player's tile, apply tile effect without dice |
| `useGekokujo()` | Swap position with top-ranked opponent; calls `applyGekokujoSwap()` |
| `applyGekokujoSwap(targetIndex, katashiroUsed, originalTopIndex, backSteps?)` | Execute the position swap; handles katashiro interception |
| `findTopOpponentIndex(playerIndex)` | Return index of highest-ranked opponent relative to given player |
| `applyMoveEffect(moveValue)` | Shared helper â€” shows modal then applies forward/backward movement |
| `useShield(itemIndex)` | Consume shield from inventory; block backward tile effect |
| `shieldSkipAndMove(moveValue)` | Decline shield use; apply backward movement normally |
| `promptKatashiroChoice(context)` | Show å½¢ä»£ intercept dialog when attacked player holds katashiro |
| `nextTurn()` | Advance turn; handles skip, nailPlacement prompt |
| `showModal(type, message, callback?, titleOverride?)` | `type`: `'info'` \| `'win'` \| `'vanished'`; `titleOverride` replaces default title |
| `buildResultText(winnerName)` | Build ranked result string for win modal |
| `eliminatePlayer()` | Remove current player from `gameState.players` (blackhole); triggers `'vanished'` modal if last player |
| `renderPlayerListPanel()` | Re-render the slide-in player list panel (local/online multi only) |
| `togglePlayerList()` | Open/close the left-side player panel |
| `exitGame()` | Return to playMode screen and reset game state |
| `createOnlineRoom()` / `joinOnlineRoom()` | Online multiplayer functions |

### Item usage timing

**Pre-roll** (usable before dice â€” `PRE_ROLL_ITEMS`):
`['boots', 'binoculars', 'timestop', 'snatcher', 'babel', 'hammer', 'gekokujo', 'kagemaiha', 'morohajoken']`

**Post-roll** (triggered after landing): `koshindo`, `sakasama`

**Reactive** (triggered when specific condition is met mid-effect):
- `shield` â€” prompted when player lands on a backward tile (`tile.effect.type === 'move'` with `value < 0`)

**Passive** (no active use): `katashiro` â€” intercepts incoming attack items; `curseddoll`

> **Note:** `PRE_ROLL_ITEMS` is defined as a local `const` in **two separate places** inside `rollDice()` â€” once for the `hasPreRollItems` check and once inside `promptItemUsage()`. Update **both** when modifying this list. Items with a precondition (e.g., `hammer` requires a co-located opponent, `snatcher` requires a target with items, `gekokujo` requires a non-self top player, `morohajoken` requires at least 1 player in game) need the precondition check added in both locations.

### babel display rule

`babel` is stored as `'babel'` in `player.items` but displayed as `â­ ã‚¹ã‚¿ãƒ¼` everywhere via `itemLabel()` and explicit `displayId = itemId === 'babel' ? 'star' : itemId` guards.

### handleEvent dispatch pattern

`handleEvent(eventEffect)` processes events in this order:
1. Early-return for events with custom UI: `merchant`, `angry`, `self_appeal`, `freemove`, `luckynumber`, `ganbare`, `newstart`, `forceend`
2. Remaining effects (`item`, `extraTurn`, `skip`, numeric, `storm`, `blackhole`, `whitehole`, `mask`, `average`, `nameback`, `resetall`) set a `callback` then fall through to a single `showModal('info', eventText, callback, eventEffect.eventTitle)` at the end.

When adding a new event with simple text + effect, use the callback pattern. For custom UI (multi-step dialog, timers, etc.), add an early-return block before the shared `showModal` call.

---

## Persistence (localStorage)

| Key | Value |
|---|---|
| `stageData_1` / `stageData_2` / `stageData_3` | JSON â€” 3 save slots, each stores `{ gridSize, board }` |
| `enabledItems` | JSON â€” `{ [itemId]: boolean }` |
| `firebaseConfig` | JSON â€” `{ apiKey, databaseURL }` |

---

## Styling Conventions

**Color palette:**
- Primary: `#667eea` / `#764ba2` (purple gradient)
- Forward tile: `#4ade80` (green)
- Backward tile: `#f87171` (red)
- Item tile: `#fbbf24` (yellow)
- Event tile: `#60a5fa` (blue)

**Naming:**
- CSS classes: kebab-case (`.tile-normal`, `.btn-primary`)
- Element IDs: camelCase (`firebaseConfigForm`, `editorMode`)
- Utility classes: `.hidden`, `.text-center`, `.mt-20`

Sections are shown/hidden with `.hidden`. Board grid regenerated via `innerHTML`. Buttons use `data-action` / `data-arg` / `data-*` attributes; clicks dispatched by central `ACTION_HANDLERS` in `js/game.js`.

---

## Code Style Guidelines

- **UI strings**: Japanese only â€” do not change to English
- **Section headers**: `// ========== Section Name ==========`
- **External CDN libraries**: Firebase SDK v8 Compat CDN + Font Awesome 6.7.2 CDN â€” no other external dependencies
- **State mutations**: mutate `gameState` directly, then call `render*()` functions
- **DOM updates**: regenerate `innerHTML`; avoid partial mutations
- **XSS safety**: always wrap user-supplied strings in `escapeHtml()` before injecting into `innerHTML`
- **User-facing errors**: `showModal('info', message)`
- **Developer feedback**: `console.log` / `console.error`

### `data-action` / `closeModal*` bridge pattern

`ACTION_HANDLERS` (global scope, ~L3739) dispatches all `data-action` button clicks. Functions called from `data-action` must be in global scope. Multi-step dialogs that need a callback after modal close use one of the pre-defined bridge functions (defined just before `ACTION_HANDLERS`):

```javascript
closeModalThenRollDice()      // closeModal() + doRollDice()
closeModalThenNextTurn()      // closeModal() + nextTurn()
closeModalThenSwitchEditor()  // closeModal() + switchMode('editor')
closeModalThenSwitchPlayMode()// closeModal() + switchMode('playMode')
closeModalThenRestartOnline() // closeModal() + restartOnlineGame()
closeModalThenNailCallback()  // closeModal() + window.nailCallback()
```

Add new bridge functions here when a `data-action` button needs to call a function that isn't already in `ACTION_HANDLERS`.

### `window.*` global state for multi-step UI flows

Multi-step dialogs (merchant, nail, self_appeal, etc.) pass state between `data-action` invocations via `window.*`:

| Variable | Used by |
|---|---|
| `window.modalCallback` | `handleModalOk()` â€” shared callback for OK-button modals |
| `window.nailCallback` | nail placement confirmation |
| `window.merchantItems3`, `window.merchantRemaining`, `window.merchantPicked` | merchant dialog state |
| `window.selfAppealCurrentPlayer`, `window.selfAppealVoters`, `window.selfAppealTimerId`, `window.selfAppealVoterArrayIndex`, `window.selfAppealCurrentVotes` | self_appeal event flow |
| `window.katashiroContext` | katashiro intercept flow â€” `{ kind, holderIndex, attackerIndex }` |

---

## Firebase / Online Multiplayer

Firebase SDK v11 Compat is loaded via CDN in `index.html` (3 `<script>` tags before `js/game.js`). "Compat" means v8-style API surface on top of v9+ internals. Room creation, game sync, waiting room player list, and host-triggered game start are all implemented. Key refs: `roomRef`, `playerRef` inside `gameState.firebaseRefs`.

Remaining TODO (marked `// TODO` in code):
- Firebase Compat â†’ v9 Modular migration (deferred)

---

## Git

- Feature/AI branches: `claude/<description>-<id>`
- `text/` directory is gitignored â€” development notes only
- `.playwright-mcp/` is gitignored â€” Playwright MCP session logs

---

## Long-term TODOs

- [ ] **Firebase Compat â†’ v9 Modular** â€” CDN v11 Compat is functional but not tree-shakeable; migration deferred
